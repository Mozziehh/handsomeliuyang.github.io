<!DOCTYPE html>
<html>
<head>
    

    

    



    <meta charset="utf-8">
    
    
    
    <title>Flutter实现Git权限分配工具之旅 | LiuYang&#39;s blog | 探索，分享，创新——追求卓越</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#3F51B5">
    
    
    <meta name="keywords" content="Android,Flutter">
    <meta name="description" content="Flutter初见 Flutter is a mobile app SDK for building high-performance, high-fidelity, apps for iOS and Android, from a single codebase.   Flutter 是一款移动应用程序 SDK，致力于使用一套代码来构建高性能、高保真的 iOS 和 Android 应用程序。 F">
<meta name="keywords" content="Android,Flutter">
<meta property="og:type" content="article">
<meta property="og:title" content="Flutter实现Git权限分配工具之旅">
<meta property="og:url" content="https://handsomeliuyang.github.io/2018/10/30/Flutter实现Git权限分配工具之旅/index.html">
<meta property="og:site_name" content="LiuYang&#39;s blog">
<meta property="og:description" content="Flutter初见 Flutter is a mobile app SDK for building high-performance, high-fidelity, apps for iOS and Android, from a single codebase.   Flutter 是一款移动应用程序 SDK，致力于使用一套代码来构建高性能、高保真的 iOS 和 Android 应用程序。 F">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://handsomeliuyang.github.io/2018/10/30/Flutter实现Git权限分配工具之旅/old-architecture.png">
<meta property="og:image" content="https://flutter.io/images/whatisflutter/diagram-layercake.svg">
<meta property="og:image" content="https://handsomeliuyang.github.io/2018/10/30/Flutter实现Git权限分配工具之旅/事件循环.png">
<meta property="og:image" content="https://handsomeliuyang.github.io/2018/10/30/Flutter实现Git权限分配工具之旅/widgets的基础组件.png">
<meta property="og:image" content="http://doc.flutter-dev.cn/images/whatisflutter/diagram-widgetclass.svg">
<meta property="og:image" content="https://handsomeliuyang.github.io/2018/10/30/Flutter实现Git权限分配工具之旅/native-view.png">
<meta property="og:image" content="https://handsomeliuyang.github.io/2018/10/30/Flutter实现Git权限分配工具之旅/hybrid.png">
<meta property="og:image" content="https://handsomeliuyang.github.io/2018/10/30/Flutter实现Git权限分配工具之旅/reactnative.png">
<meta property="og:image" content="https://handsomeliuyang.github.io/2018/10/30/Flutter实现Git权限分配工具之旅/flutter.png">
<meta property="og:image" content="https://handsomeliuyang.github.io/2018/10/30/Flutter实现Git权限分配工具之旅/框架.png">
<meta property="og:image" content="https://handsomeliuyang.github.io/2018/10/30/Flutter实现Git权限分配工具之旅/pubspec.yaml.png">
<meta property="og:image" content="https://handsomeliuyang.github.io/2018/10/30/Flutter实现Git权限分配工具之旅/redux_architecture.png">
<meta property="og:image" content="https://handsomeliuyang.github.io/2018/10/30/Flutter实现Git权限分配工具之旅/flutter-redux-apply.png">
<meta property="og:image" content="https://handsomeliuyang.github.io/2018/10/30/Flutter实现Git权限分配工具之旅/redux-catalog.png">
<meta property="og:image" content="https://handsomeliuyang.github.io/2018/10/30/Flutter实现Git权限分配工具之旅/mainpage.png">
<meta property="og:image" content="https://handsomeliuyang.github.io/2018/10/30/Flutter实现Git权限分配工具之旅/drawer.png">
<meta property="og:image" content="https://handsomeliuyang.github.io/2018/10/30/Flutter实现Git权限分配工具之旅/state-lifecycle.png">
<meta property="og:image" content="https://handsomeliuyang.github.io/2018/10/30/Flutter实现Git权限分配工具之旅/project.png">
<meta property="og:updated_time" content="2018-11-11T09:59:45.416Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Flutter实现Git权限分配工具之旅">
<meta name="twitter:description" content="Flutter初见 Flutter is a mobile app SDK for building high-performance, high-fidelity, apps for iOS and Android, from a single codebase.   Flutter 是一款移动应用程序 SDK，致力于使用一套代码来构建高性能、高保真的 iOS 和 Android 应用程序。 F">
<meta name="twitter:image" content="https://handsomeliuyang.github.io/2018/10/30/Flutter实现Git权限分配工具之旅/old-architecture.png">
    
        <link rel="alternate" type="application/atom+xml" title="LiuYang&#39;s blog" href="/atom.xml">
    
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="stylesheet" href="/css/style.css?v=1.7.2">
    <script>window.lazyScripts=[]</script>

    <!-- custom head -->
    

</head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="hide" >
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap" style="background-image:url(/img/brand.jpg)">
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/logo.png">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">刘阳</h5>
          <a href="mailto:40610243@qq.com" title="40610243@qq.com" class="mail">40610243@qq.com</a>
        </hgroup>
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="waves-block waves-effect">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                主页
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                归档
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                标签
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories"  >
                <i class="icon icon-lg icon-th-list"></i>
                类别
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/about"  >
                <i class="icon icon-lg icon-link"></i>
                关于
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">Flutter实现Git权限分配工具之旅</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input" autocomplete="off" placeholder="输入感兴趣的关键字">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menuShare">
            <i class="icon icon-lg icon-share-alt"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">

    <div class="container fade-scale">
        <h1 class="title">Flutter实现Git权限分配工具之旅</h1>
        <h5 class="subtitle">
            
                <time datetime="2018-10-30T06:40:35.000Z" itemprop="datePublished" class="page-time">
  2018-10-30
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Android/">Android</a></li></ul>

            
        </h5>
    </div>

    


</header>


<div class="container body-wrap">
    
    <aside class="post-widget">
        <nav class="post-toc-wrap post-toc-shrink" id="post-toc">
            <h4>TOC</h4>
            <ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#Flutter初见"><span class="post-toc-number">1.</span> <span class="post-toc-text">Flutter初见</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#Git权限分配工具简介"><span class="post-toc-number">2.</span> <span class="post-toc-text">Git权限分配工具简介</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#框架结构"><span class="post-toc-number">2.1.</span> <span class="post-toc-text">框架结构</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#redux"><span class="post-toc-number">2.1.1.</span> <span class="post-toc-text">redux</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#network"><span class="post-toc-number">2.1.2.</span> <span class="post-toc-text">network</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#MainPage"><span class="post-toc-number">2.2.</span> <span class="post-toc-text">MainPage</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Drawer"><span class="post-toc-number">2.3.</span> <span class="post-toc-text">Drawer</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Permission"><span class="post-toc-number">2.4.</span> <span class="post-toc-text">Permission</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Project"><span class="post-toc-number">2.5.</span> <span class="post-toc-text">Project</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#总结"><span class="post-toc-number">3.</span> <span class="post-toc-text">总结</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#参考"><span class="post-toc-number">4.</span> <span class="post-toc-text">参考</span></a></li></ol>
        </nav>
    </aside>


<article id="post-Flutter实现Git权限分配工具之旅"
  class="post-article article-type-post fade" itemprop="blogPost">

    <div class="post-card">
        <h1 class="post-card-title">Flutter实现Git权限分配工具之旅</h1>
        <div class="post-meta">
            <time class="post-time" title="2018-10-30 14:40:35" datetime="2018-10-30T06:40:35.000Z"  itemprop="datePublished">2018-10-30</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Android/">Android</a></li></ul>



            
<span id="busuanzi_container_page_pv" title="文章总阅读量" style='display:none'>
    <i class="icon icon-eye icon-pr"></i><span id="busuanzi_value_page_pv"></span>
</span>


        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            <h1 id="Flutter初见"><a href="#Flutter初见" class="headerlink" title="Flutter初见"></a>Flutter初见</h1><blockquote>
<p>Flutter is a mobile app SDK for building high-performance, high-fidelity, apps for iOS and Android, from a single codebase. </p>
</blockquote>
<p>Flutter 是一款移动应用程序 SDK，致力于使用一套代码来构建高性能、高保真的 iOS 和 Android 应用程序。</p>
<p><strong>Flutter的优势：</strong></p>
<ol>
<li>开发效率高：<ol>
<li>一套代码开发 iOS 和 Android</li>
<li>热加载（hot reload）</li>
</ol>
</li>
<li>创建美观，高度定制的用户体验<ol>
<li>Material Design 和 Cupertino （iOS 风格）Widget</li>
<li>实现定制，美观，品牌驱动的设计，而不受 OEM Widget 集的限制</li>
</ol>
</li>
</ol>
<p><strong>框架结构（Architecture）</strong><br><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2018/10/30/Flutter实现Git权限分配工具之旅/old-architecture.png" alt="" title="">
                </div>
                <div class="image-caption"></div>
            </figure></p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://flutter.io/images/whatisflutter/diagram-layercake.svg" alt="" title="">
                </div>
                <div class="image-caption"></div>
            </figure>
<ol>
<li><strong><a href="https://skia.org/" target="_blank" rel="noopener">Skia</a>：</strong>开源的2d图形库。其已作为Chrome, Chrome OS, Android, Firefox, Firefox OS等其他众多产品的图形引擎，支持平台还包括Windows,macOS,iOS8+,Ubuntu14.04+等。</li>
<li><strong>Dart：</strong><ol>
<li>debug：JIT(Just In Time)编译，运行时分析、编译，运行较慢。Hot Reload基于JIT运行</li>
<li>release：AOT(Ahead Of Time)编译，生成了原生的arm代码，开发期间较慢，但运行期间快</li>
<li>一切都是对象，甚至数字，函数，和null都是对象</li>
<li>默认publick，通过加(_)标记为私有</li>
<li>单线程，没有锁的概念</li>
</ol>
</li>
<li><strong>Text：</strong>文本渲染</li>
</ol>
<p><strong>Dart的线程模型</strong></p>
<p>Flutter与Android一样，通过Main线程和消息循环实现UI绘制操作与UI事件，如下所示：<br><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2018/10/30/Flutter实现Git权限分配工具之旅/事件循环.png" alt="" title="">
                </div>
                <div class="image-caption"></div>
            </figure></p>
<p>Dart的不同点：</p>
<ol>
<li>Dart是单线程执行，通过Future来实现异步编程，只是把任务暂时放在消息队列里，本质还是单线程执行，与javascript类型</li>
<li>两个消息队列：event队列和microtask队列</li>
</ol>
<p>单线程带来的问题：单某个任务执行时间过长，超过16ms时，会导致丢帧，给用户的感觉就是卡顿，React借助requestIdleCallback Api实现了卡顿优化，<a href="https://handsomeliuyang.github.io/2018/08/07/DiyReact%E5%AD%A6%E4%B9%A0%E4%B9%8B%E8%B7%AF/">详情请参考</a></p>
<p>Dart解决这个问题的方案：通过<a href="https://docs.flutter.io/flutter/dart-isolate/Isolate-class.html" target="_blank" rel="noopener">Isolate</a>真正意义上创建线程，但此线程与java里的线程不一样：isolates之间不会共享内存，更像进程，通过传递message来进行交流，<a href="https://flutter.io/docs/cookbook/networking/background-parsing" target="_blank" rel="noopener">Demo</a></p>
<p><strong>一切都是Widget</strong></p>
<p>Widgets是Flutter应用程序用户界面的基础构建模块，Widgets包含了views，view controllers，layouts等等能力。</p>
<p>Flutter提供了很多基组Widgets，但这些Widgets有一个与Android最大的不同点：每个Widget的能力很单一，如Text Widget，没有width, height, padding,color等等属性，需要借助其他Widget。</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2018/10/30/Flutter实现Git权限分配工具之旅/widgets的基础组件.png" alt="" title="">
                </div>
                <div class="image-caption"></div>
            </figure>
<p>更多细节请查看：<a href="https://www.jianshu.com/p/9e6c470ea5bf" target="_blank" rel="noopener">Flutter快速上车之Widget</a></p>
<p><strong>StatelessWidget &amp; StatefulWidget</strong></p>
<p>Flutter的widget分为无状态和有状态，如下所示：<br><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="http://doc.flutter-dev.cn/images/whatisflutter/diagram-widgetclass.svg" alt="" title="">
                </div>
                <div class="image-caption"></div>
            </figure></p>
<p>如何选择？下面是我的一些经验：</p>
<ol>
<li>包含TextField的widget — StatefulWidget</li>
<li>用户交互时，产出的数据，如点击计数<ol>
<li>局部数据 — StatefulWidget</li>
<li>全局数据（store存储） — StatelessWidget</li>
</ol>
</li>
<li>默认为StatelessWidget</li>
</ol>
<p><strong>Widget，Element，RenderObject</strong></p>
<p>Flutter里的Widgets，Elements, RenderObject三要素与React中的Element，Instance/Fiber, Dom有点类似</p>
<ol>
<li>Widgets：widget tree，只是属性集合，需要被绘制的属性集合，每次build，都是新对象，所以属性都要用final修饰</li>
<li>Elements：element tree，concrete widget tree，diff操作，每次build，不会重新构建，进行diff和update</li>
<li>RenderObject：真正负责layout, rendering等等操作，一般是由element创建</li>
</ol>
<p><strong>Flutter的性能</strong></p>
<p>Flutter性能要高的原因：</p>
<ol>
<li>debug为字节码，release为机器码</li>
<li>不依赖OEM widgets</li>
<li>没有bridge</li>
</ol>
<blockquote>
<p><strong>Native View:</strong><br><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2018/10/30/Flutter实现Git权限分配工具之旅/native-view.png" alt="" title="">
                </div>
                <div class="image-caption"></div>
            </figure></p>
<p><strong>Hybrid:</strong><br><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2018/10/30/Flutter实现Git权限分配工具之旅/hybrid.png" alt="" title="">
                </div>
                <div class="image-caption"></div>
            </figure></p>
<p><strong>ReactNative:</strong><br><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2018/10/30/Flutter实现Git权限分配工具之旅/reactnative.png" alt="" title="">
                </div>
                <div class="image-caption"></div>
            </figure></p>
<p><strong>Flutter</strong><br><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2018/10/30/Flutter实现Git权限分配工具之旅/flutter.png" alt="" title="">
                </div>
                <div class="image-caption"></div>
            </figure></p>
</blockquote>
<font color="#ff0000">注意：以上只是从实现角度分析，在机器性能好的情况下，实际差距不大</font>

<h1 id="Git权限分配工具简介"><a href="#Git权限分配工具简介" class="headerlink" title="Git权限分配工具简介"></a>Git权限分配工具简介</h1><p>为不同类型的角色批量分配Git权限的工具，整体效果如下：</p>
<iframe height="520" width="100%" src="/2018/10/30/Flutter实现Git权限分配工具之旅/flutter-igit.gif" frameborder="0" allowfullscreen></iframe>

<p>源码下载地址：<a href="https://github.com/handsomeliuyang/flutter-igit" target="_blank" rel="noopener">https://github.com/handsomeliuyang/flutter-igit</a></p>
<h2 id="框架结构"><a href="#框架结构" class="headerlink" title="框架结构"></a>框架结构</h2><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2018/10/30/Flutter实现Git权限分配工具之旅/框架.png" alt="" title="">
                </div>
                <div class="image-caption"></div>
            </figure>
<ol>
<li>pubspec.yaml：与package.json/build.grale类似，用于配置程序的信息，如下所示：<br> <img src="/2018/10/30/Flutter实现Git权限分配工具之旅/pubspec.yaml.png" alt=""></li>
<li>assets：用于存放内置图片与资源，自建目录可修改</li>
<li><p>lib：src目录，按功能模块分为：</p>
<ol>
<li>main.dart/main_dev.dart：程序的入口文件，与c语言类似，dart程序的入口为main()函数，main_dev.dart的区别是使用DevToolsStore，用于查看store与action</li>
<li><p>App.dart：最外层的配置，如下所示：</p>
 <figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@override</span></div><div class="line">Widget build(BuildContext context) &#123;</div><div class="line">    <span class="keyword">return</span> StoreProvider( <span class="comment">// 使用Redux的要求</span></div><div class="line">        store: widget.store,</div><div class="line">        child: <span class="keyword">new</span> MaterialApp( <span class="comment">// 使用Material要求</span></div><div class="line">            title: <span class="string">'Flutter igit'</span>, </div><div class="line">            theme: <span class="keyword">new</span> ThemeData( <span class="comment">// 全局样式</span></div><div class="line">                primaryColor: <span class="keyword">const</span> Color(<span class="number">0xFF1C306D</span>),</div><div class="line">                accentColor: <span class="keyword">const</span> Color(<span class="number">0xFFFFAD32</span>),</div><div class="line">            ),</div><div class="line">            home: MainPage(</div><div class="line">                devDrawerBuilder: widget.devDrawerBuilder</div><div class="line">            ),</div><div class="line">        ),</div><div class="line">    );</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>按功能划分目录：models, networking, redux, ui, utils</p>
</li>
</ol>
</li>
</ol>
<h3 id="redux"><a href="#redux" class="headerlink" title="redux"></a>redux</h3><p>redux的结构非常简单，如下所示：<br><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2018/10/30/Flutter实现Git权限分配工具之旅/redux_architecture.png" alt="" title="">
                </div>
                <div class="image-caption"></div>
            </figure></p>
<p>由于Flutter是一个类似MVVM框架，所以通过StoreConnector实现数据监听，如下所示：<br><figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@override</span></div><div class="line">Widget build(BuildContext context) &#123;</div><div class="line">    <span class="keyword">return</span> StoreConnector&lt;AppState, DrawListViewModel&gt; (</div><div class="line">        distinct: <span class="keyword">true</span>,</div><div class="line">        converter: (store) =&gt; DrawListViewModel.fromStore(store),</div><div class="line">        builder: (context, viewModel)&#123;</div><div class="line">            <span class="keyword">return</span> DrawListContent(</div><div class="line">                header: <span class="keyword">this</span>.header,</div><div class="line">                viewModel: viewModel,</div><div class="line">            );</div><div class="line">        &#125;,</div><div class="line">    );</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在Flutter里，应用了Redux后的实现结构为：<br><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2018/10/30/Flutter实现Git权限分配工具之旅/flutter-redux-apply.png" alt="" title="">
                </div>
                <div class="image-caption"></div>
            </figure></p>
<p>Redux是全局单例，应用的功能模块很多，所以redux的目录与state按功能模块的划分更加合适，如下所示：<br><figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">AppState</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">final</span> TradelineState tradelineState;</div><div class="line">    <span class="keyword">final</span> PermissionState permissionState;</div><div class="line">    <span class="keyword">final</span> ProjectState projectState;</div><div class="line"></div><div class="line">    AppState(&#123;</div><div class="line">        <span class="meta">@required</span> <span class="keyword">this</span>.tradelineState,</div><div class="line">        <span class="meta">@required</span> <span class="keyword">this</span>.permissionState,</div><div class="line">        <span class="meta">@required</span> <span class="keyword">this</span>.projectState</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    <span class="keyword">static</span> initial() &#123;</div><div class="line">        <span class="keyword">return</span> AppState(</div><div class="line">            tradelineState: TradelineState.initial(),</div><div class="line">            permissionState: PermissionState.initial(),</div><div class="line">            projectState: ProjectState.initial()</div><div class="line">        );</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2018/10/30/Flutter实现Git权限分配工具之旅/redux-catalog.png" alt="" title="">
                </div>
                <div class="image-caption"></div>
            </figure>
<h3 id="network"><a href="#network" class="headerlink" title="network"></a>network</h3><p>flutter的http请求很简单，主要是使用两个Api：http，Uri，如下所示：<br><figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">Future&lt;<span class="built_in">List</span>&lt;GitProject&gt;&gt; getGroups(<span class="built_in">int</span> page, <span class="built_in">String</span> search) <span class="keyword">async</span> &#123;</div><div class="line">    <span class="built_in">Uri</span> uri = <span class="built_in">Uri</span>.http(</div><div class="line">        AUTHORITY,</div><div class="line">        <span class="string">'<span class="subst">$&#123;FIXED_PATH&#125;</span>/groups'</span>,</div><div class="line">        &lt;<span class="built_in">String</span>, <span class="built_in">String</span>&gt;&#123;</div><div class="line">            <span class="string">'private_token'</span>: Config.LIUYANG_TOKEN,</div><div class="line">            <span class="string">'per_page'</span>: PER_PAGE.toString(),</div><div class="line">            <span class="string">'all_available'</span>: <span class="string">'true'</span>,</div><div class="line">            <span class="string">'page'</span>:<span class="string">'<span class="subst">$&#123;page&#125;</span>'</span>,</div><div class="line">            <span class="string">'search'</span>:<span class="string">'com.wuba'</span></div><div class="line">        &#125;);</div><div class="line"></div><div class="line">    <span class="keyword">final</span> response = <span class="keyword">await</span> http.<span class="keyword">get</span>(uri.toString());</div><div class="line">    <span class="keyword">final</span> jsonResponse = json.decode(response.body);</div><div class="line"></div><div class="line">    debugPrint(<span class="string">'liuyang <span class="subst">$&#123;jsonResponse&#125;</span>'</span>);</div><div class="line"></div><div class="line">    <span class="keyword">if</span>(response.statusCode == <span class="number">200</span>)&#123;</div><div class="line">        <span class="built_in">List</span>&lt;GitProject&gt; groups = <span class="built_in">List</span>&lt;GitProject&gt;();</div><div class="line">        <span class="keyword">for</span>(<span class="built_in">int</span> i=<span class="number">0</span>; i&lt;jsonResponse.length; i++)&#123;</div><div class="line">            groups.add(GitProject.fromJson(jsonResponse[i], ProjectType.group));</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> groups;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">throw</span> Exception(<span class="string">'Failed <span class="subst">$&#123;response.statusCode&#125;</span> <span class="subst">$&#123;response.body&#125;</span>'</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><strong>注意：</strong></p>
<ol>
<li>上面是通过async,Future实现异步操作，但此异步并不是真正的开异步线程，只是把任务放在队列里，延迟执行而已，应该使用isolate实现真正的异步执行</li>
<li>面向对象编程，每个Model里，都有两个Api：fromJson()，toJson()</li>
</ol>
<h2 id="MainPage"><a href="#MainPage" class="headerlink" title="MainPage"></a>MainPage</h2><p>整体效果：<br><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2018/10/30/Flutter实现Git权限分配工具之旅/mainpage.png" alt="" title="">
                </div>
                <div class="image-caption"></div>
            </figure><br>关键点：</p>
<ol>
<li>此框架页包含：AppBar，Drawer，DevDrawer，PermissionPage</li>
<li><p>此框架默认应该是StatelessWidget，但由于AppBar的title需要动态拼接，导致只能改为StatefulWidget，如下：</p>
 <figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">_MyPageState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">MainPage</span>&gt; </span>&#123;</div><div class="line">    Widget _buildTitle(BuildContext context) &#123;</div><div class="line">        <span class="keyword">return</span> StoreConnector&lt;AppState, Tradeline&gt;(</div><div class="line">            distinct: <span class="keyword">true</span>,</div><div class="line">            converter: (store) =&gt; store.state.tradelineState.current,</div><div class="line">            builder: (BuildContext context, Tradeline currentTradeline) &#123;</div><div class="line">                <span class="keyword">return</span> Text(</div><div class="line">                    <span class="string">'分配 <span class="subst">$&#123;currentTradeline?.name ?? <span class="string">''</span>&#125;</span> 的igit权限'</span></div><div class="line">                );</div><div class="line">            &#125;,</div><div class="line">        );</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@override</span></div><div class="line">    Widget build(BuildContext context) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Scaffold(</div><div class="line">            appBar: <span class="keyword">new</span> AppBar(title: _buildTitle(context)),</div><div class="line">            drawer: Drawer(</div><div class="line">                child: DrawList(</div><div class="line">                    header: DrawListHeader()</div><div class="line">                ),</div><div class="line">            ),</div><div class="line">            endDrawer: widget.devDrawerBuilder != <span class="keyword">null</span> ? widget.devDrawerBuilder(context) : <span class="keyword">null</span>,</div><div class="line">            body: PermissionPage(),</div><div class="line">        );</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>dart里创建对象时，new关键字不是必需的，如下：</p>
 <figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Shape</span> </span>&#123;</div><div class="line">&#125;</div><div class="line"></div><div class="line">Shape shape = <span class="keyword">new</span> Shape();</div><div class="line">Shape shape1 = Shape();</div></pre></td></tr></table></figure>
<p> 在build时，个人感觉省略掉new关键字，可读性更强</p>
</li>
</ol>
<h2 id="Drawer"><a href="#Drawer" class="headerlink" title="Drawer"></a>Drawer</h2><p>效果如下：<br><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2018/10/30/Flutter实现Git权限分配工具之旅/drawer.png" alt="" title="">
                </div>
                <div class="image-caption"></div>
            </figure></p>
<p>功能比较简单，思路如下：</p>
<ol>
<li>通过StoreConnector，获取并监听Store</li>
<li>构建ListView</li>
</ol>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">DrawList</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> Widget header;</div><div class="line"></div><div class="line">    DrawList(&#123;</div><div class="line">        <span class="meta">@required</span> <span class="keyword">this</span>.header</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    <span class="meta">@override</span></div><div class="line">    Widget build(BuildContext context) &#123;</div><div class="line">        <span class="keyword">return</span> StoreConnector&lt;AppState, DrawListViewModel&gt; (</div><div class="line">            distinct: <span class="keyword">true</span>,</div><div class="line">            converter: (store) =&gt; DrawListViewModel.fromStore(store),</div><div class="line">            builder: (context, viewModel)&#123;</div><div class="line">                <span class="keyword">return</span> DrawListContent(</div><div class="line">                    header: <span class="keyword">this</span>.header,</div><div class="line">                    viewModel: viewModel,</div><div class="line">                );</div><div class="line">            &#125;,</div><div class="line">        );</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">DrawListContent</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">final</span> Widget header;</div><div class="line">    <span class="keyword">final</span> DrawListViewModel viewModel;</div><div class="line"></div><div class="line">    DrawListContent(&#123;</div><div class="line">        <span class="meta">@required</span> <span class="keyword">this</span>.header,</div><div class="line">        <span class="meta">@required</span> <span class="keyword">this</span>.viewModel</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    <span class="meta">@override</span></div><div class="line">    Widget build(BuildContext context) &#123;</div><div class="line">        <span class="keyword">return</span> ListView.builder(</div><div class="line">            itemCount: <span class="keyword">this</span>.viewModel.tradelines.length + <span class="number">1</span>,</div><div class="line">            itemBuilder: (BuildContext context, <span class="built_in">int</span> index) &#123;</div><div class="line">                <span class="keyword">if</span> (index == <span class="number">0</span>) &#123;</div><div class="line">                    <span class="keyword">return</span> <span class="keyword">this</span>.header;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                Tradeline tradeline = <span class="keyword">this</span>.viewModel.tradelines[index - <span class="number">1</span>];</div><div class="line">                <span class="built_in">bool</span> isSelected = <span class="keyword">this</span>.viewModel.currentTradeline.name ==</div><div class="line">                    tradeline.name;</div><div class="line">                <span class="keyword">var</span> backgroundColor = isSelected</div><div class="line">                    ? <span class="keyword">const</span> Color(<span class="number">0xFFEEEEEE</span>)</div><div class="line">                    : Theme</div><div class="line">                    .of(context)</div><div class="line">                    .canvasColor;</div><div class="line"></div><div class="line">                <span class="keyword">return</span> Material(</div><div class="line">                    color: backgroundColor,</div><div class="line">                    child: ListTile(</div><div class="line">                        onTap: () &#123;</div><div class="line">                            viewModel.changeCurrentTradeline(tradeline);</div><div class="line">                            Navigator.pop(context);</div><div class="line">                        &#125;,</div><div class="line">                        selected: isSelected,</div><div class="line">                        title: Text(tradeline.name),</div><div class="line">                    ),</div><div class="line">                );</div><div class="line">            &#125;</div><div class="line">        );</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>关键点：</p>
<ol>
<li>ListTile的属性有限，设置Item的背景通过Material Widget，也可以通过Container Widget</li>
<li>ListView没有header的概念，都是item</li>
<li>ListView没有分隔线的Api，分隔线是由Item实现，通过ListTile.divideTiles()实现，其内部是通过DecoratedBox Widget实现</li>
<li>Navigator栈：Drawer，Dialog，Route都由Navigator栈管理，所以如下操作都是出栈操作Navigator.pop(context)：<ol>
<li>dismiss drawer</li>
<li>dismiss dialog</li>
<li>Back</li>
</ol>
</li>
</ol>
<h2 id="Permission"><a href="#Permission" class="headerlink" title="Permission"></a>Permission</h2><p>Panel效果的源码来自：flutter_gallery里的Expansion panels例子，个人学习新技术的过程：</p>
<ol>
<li>看官方的文档</li>
<li>运行官方demo，思考如何实现，对照源码的实现</li>
</ol>
<p>具体的代码，可通过下载源码查看，这里重点讲一下Flutter的生命周期函数，在Flutter里，StatelessWidget和StatefulWidget没有生命周期，因为其是不可变的，只有State才有生命周期，如下所示：<br><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2018/10/30/Flutter实现Git权限分配工具之旅/state-lifecycle.png" alt="" title="">
                </div>
                <div class="image-caption"></div>
            </figure></p>
<p>当数据变化时，StatelessWidget与StatefulWidget每次都会创建新的对象，并执行build()函数，State会被复用，造成flutter程序的如下特点：</p>
<ol>
<li>StatelessWidget, StatefulWidget里的成员变量都是final的，可以理解为React里的props</li>
<li>State里的成员变量可以理解为React里的state，即为局部变量（Store里的为全局变量）</li>
<li>State的initState()只执行一次，如果成员变量需要依据props而修改，可以在didUpdateWidget()里更新</li>
<li>修改State的成员变量时，如果希望界面需要同步修改，需要在setState()里修改，如下所示：— <font color="#ff0000">大家可以对比下与React的setState()有什么区别？</font> <figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">setState(() &#123;</div><div class="line">    item.isExpanded = <span class="keyword">false</span>;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
</li>
</ol>
<p>如下所示：<br><figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">PermissionContent</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> <span class="built_in">List</span>&lt;GitProject&gt; projects;</div><div class="line">    <span class="keyword">final</span> <span class="built_in">List</span>&lt;GitUser&gt; users;</div><div class="line">    <span class="keyword">final</span> <span class="built_in">Function</span> addGitProject;</div><div class="line">    <span class="keyword">final</span> <span class="built_in">Function</span> deleteGitProject;</div><div class="line">    <span class="keyword">final</span> <span class="built_in">Function</span> getUserIdByName;</div><div class="line">    <span class="keyword">final</span> <span class="built_in">Function</span> deleteGitUser;</div><div class="line">    <span class="keyword">final</span> <span class="built_in">Function</span> allocationPermission;</div><div class="line"></div><div class="line">    <span class="keyword">const</span> PermissionContent(&#123;</div><div class="line">        <span class="meta">@required</span> <span class="keyword">this</span>.projects,</div><div class="line">        <span class="meta">@required</span> <span class="keyword">this</span>.users,</div><div class="line">        <span class="meta">@required</span> <span class="keyword">this</span>.addGitProject,</div><div class="line">        <span class="meta">@required</span> <span class="keyword">this</span>.deleteGitProject,</div><div class="line">        <span class="meta">@required</span> <span class="keyword">this</span>.getUserIdByName,</div><div class="line">        <span class="meta">@required</span> <span class="keyword">this</span>.deleteGitUser,</div><div class="line">        <span class="meta">@required</span> <span class="keyword">this</span>.allocationPermission</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    <span class="meta">@override</span></div><div class="line">    _PermissionContentState createState() =&gt; _PermissionContentState();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">_PermissionContentState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">PermissionContent</span>&gt; </span>&#123;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">String</span>&gt; ACCESS_LEVEL = &#123;...&#125;;</div><div class="line"></div><div class="line">    <span class="built_in">List</span>&lt;PanelItem&gt; _panelItems;</div><div class="line">    PanelItem _userPanelItem;</div><div class="line">    PanelItem _rolePanelItem;</div><div class="line">    PanelItem _projectPanelItem;</div><div class="line"></div><div class="line">    <span class="meta">@override</span></div><div class="line">    <span class="keyword">void</span> initState() &#123;</div><div class="line">        <span class="keyword">super</span>.initState();</div><div class="line">        _userPanelItem = _initUserPanelItem();</div><div class="line">        _rolePanelItem = _initRolePanelItem();</div><div class="line">        _projectPanelItem = _initProjectPanelItem();</div><div class="line">        _panelItems = &lt;PanelItem&gt;[</div><div class="line">            _userPanelItem,</div><div class="line">            _rolePanelItem,</div><div class="line">            _projectPanelItem</div><div class="line">        ];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@override</span></div><div class="line">    <span class="keyword">void</span> didUpdateWidget(PermissionContent oldWidget) &#123;</div><div class="line">        <span class="keyword">super</span>.didUpdateWidget(oldWidget);</div><div class="line">        <span class="comment">// 更新数据</span></div><div class="line">        _projectPanelItem.value = widget.projects;</div><div class="line">        _userPanelItem.value = widget.users;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">void</span> _navigatorProjectPage(BuildContext context) <span class="keyword">async</span> &#123;...&#125;</div><div class="line"></div><div class="line">    PanelItem _initUserPanelItem() &#123;...&#125;</div><div class="line"></div><div class="line">    PanelItem _initRolePanelItem() &#123;...&#125;</div><div class="line"></div><div class="line">    PanelItem _initProjectPanelItem() &#123;...&#125;</div><div class="line">    </div><div class="line">    <span class="meta">@override</span></div><div class="line">    Widget build(BuildContext context) &#123;...&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><strong> 交互反馈 </strong></p>
<p>除了通过Widget构建界面外，有时我们还需要给用户交互反馈：</p>
<ol>
<li><p>Toasts/Snackbars：仅信息反馈，定时消失，不进Navigator栈</p>
 <figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Scaffold.of(context).showSnackBar(<span class="keyword">new</span> SnackBar(</div><div class="line">    content: <span class="keyword">new</span> Text(<span class="string">"权限分配成功"</span>),</div><div class="line">));</div></pre></td></tr></table></figure>
</li>
<li><p>Dialog：信息反馈，有进一步交互，Natvigator栈管理</p>
 <figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// show:</span></div><div class="line">showDialog(</div><div class="line">    context: context,</div><div class="line">    barrierDismissible: <span class="keyword">false</span>,</div><div class="line">    builder: (BuildContext context)&#123;</div><div class="line">        <span class="keyword">return</span> Dialog(</div><div class="line">            child: Row(</div><div class="line">                mainAxisSize: MainAxisSize.min,</div><div class="line">                children: [</div><div class="line">                    CircularProgressIndicator(),</div><div class="line">                    Text(<span class="string">"Loading"</span>),</div><div class="line">                ],</div><div class="line">            ),</div><div class="line">        );</div><div class="line">    &#125;</div><div class="line">);</div><div class="line"><span class="comment">// Dismiss:</span></div><div class="line">Navigator.pop(context);</div></pre></td></tr></table></figure>
</li>
</ol>
<p>Dialog仅仅只是modal，无法通过props来控制显示与消失，只能监听局部变量state或全局变量store来控制show与dismiss，分配权限的过程的代码如下：<br><figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 创建Completer对象</span></div><div class="line">Completer&lt;<span class="built_in">bool</span>&gt; completer = Completer&lt;<span class="built_in">bool</span>&gt;();</div><div class="line"><span class="comment">// 发送action，通过igit的Api分配权限</span></div><div class="line">widget.allocationPermission(completer, users, level, projects);</div><div class="line"></div><div class="line"><span class="comment">// 同时显示LoadingDialog</span></div><div class="line">showDialog(</div><div class="line">    context: context,</div><div class="line">    barrierDismissible: <span class="keyword">false</span>,</div><div class="line">    builder: (BuildContext context)&#123;</div><div class="line">        <span class="keyword">return</span> Dialog(</div><div class="line">            child: Row(</div><div class="line">                mainAxisSize: MainAxisSize.min,</div><div class="line">                children: [</div><div class="line">                    CircularProgressIndicator(),</div><div class="line">                    Text(<span class="string">"Loading"</span>),</div><div class="line">                ],</div><div class="line">            ),</div><div class="line">        );</div><div class="line">    &#125;</div><div class="line">);</div><div class="line"><span class="comment">// 监听成功与失败，并显示不同Toasts</span></div><div class="line">completer.future.then((user)&#123;</div><div class="line">    Navigator.pop(context);</div><div class="line"></div><div class="line">    Scaffold.of(context).showSnackBar(<span class="keyword">new</span> SnackBar(</div><div class="line">        content: <span class="keyword">new</span> Text(<span class="string">"权限分配成功"</span>),</div><div class="line">    ));</div><div class="line"></div><div class="line">&#125;, onError: (e)&#123;</div><div class="line">    Navigator.pop(context);</div><div class="line"></div><div class="line">    Scaffold.of(context).showSnackBar(<span class="keyword">new</span> SnackBar(</div><div class="line">        content: <span class="keyword">new</span> Text(<span class="string">"权限分配失败 <span class="subst">$&#123;e&#125;</span>"</span>),</div><div class="line">    ));</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<h2 id="Project"><a href="#Project" class="headerlink" title="Project"></a>Project</h2><p>效果如下：<br><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2018/10/30/Flutter实现Git权限分配工具之旅/project.png" alt="" title="">
                </div>
                <div class="image-caption"></div>
            </figure></p>
<p>详细细节请查看代码，重点分享其中几个关键点</p>
<p><strong>LoadingView</strong><br>除静态页面外，所有的页面都有一个共同的加载流程：加载中…，失败/成功。统一实现LoadingView，如下所示：<br><figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProjectListWrap</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">final</span> ProjectListViewModel projectListViewModel;</div><div class="line"></div><div class="line">    ProjectListWrap(&#123;</div><div class="line">        <span class="keyword">this</span>.projectListViewModel</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    <span class="meta">@override</span></div><div class="line">    Widget build(BuildContext context) &#123;</div><div class="line">        <span class="keyword">return</span> LoadingView(</div><div class="line">            status: projectListViewModel.status,</div><div class="line">            loadingContent: PlatformAdaptiveProgressIndicator(),</div><div class="line">            errorContent: ErrorView(</div><div class="line">                description: <span class="string">'加载出错'</span>,</div><div class="line">                onRetry: projectListViewModel.refreshProjects,</div><div class="line">            ),</div><div class="line">            successContent: ProjectListContent(</div><div class="line">                projects: projectListViewModel.projects,</div><div class="line">                nextState: projectListViewModel.nextStatus,</div><div class="line">                currentPage: projectListViewModel.currentPage,</div><div class="line">                hasNext: projectListViewModel.hasNext,</div><div class="line">                refreshProjects: projectListViewModel.refreshProjects,</div><div class="line">                fetchNextProjects: projectListViewModel.fetchNextProjects,</div><div class="line">            ),</div><div class="line">        );</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><strong>下滑加载下一页</strong><br>列表数据很多，通过滑动动态加载下一页数据，监听的方式与Android的类似，通过监听其滑动位置，同时由于滑动是有状态的，所以要使用StatefulWidget，如下所示：<br><figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProjectListContent</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">final</span> <span class="built_in">List</span>&lt;GitProject&gt; projects;</div><div class="line">    <span class="keyword">final</span> LoadingStatus nextState;</div><div class="line">    <span class="keyword">final</span> <span class="built_in">int</span> currentPage;</div><div class="line">    <span class="keyword">final</span> <span class="built_in">bool</span> hasNext;</div><div class="line">    <span class="keyword">final</span> <span class="built_in">Function</span> refreshProjects;</div><div class="line">    <span class="keyword">final</span> <span class="built_in">Function</span> fetchNextProjects;</div><div class="line"></div><div class="line">    ProjectListContent(&#123;</div><div class="line">        <span class="meta">@required</span> <span class="keyword">this</span>.projects,</div><div class="line">        <span class="meta">@required</span> <span class="keyword">this</span>.nextState,</div><div class="line">        <span class="meta">@required</span> <span class="keyword">this</span>.currentPage,</div><div class="line">        <span class="meta">@required</span> <span class="keyword">this</span>.hasNext,</div><div class="line">        <span class="meta">@required</span> <span class="keyword">this</span>.refreshProjects,</div><div class="line">        <span class="meta">@required</span> <span class="keyword">this</span>.fetchNextProjects</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    <span class="meta">@override</span></div><div class="line">    State&lt;StatefulWidget&gt; createState() =&gt; _ProjectListContentState();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">_ProjectListContentState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">ProjectListContent</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">final</span> ScrollController scrollController = ScrollController();</div><div class="line"></div><div class="line">    <span class="meta">@override</span></div><div class="line">    <span class="keyword">void</span> initState() &#123;</div><div class="line">        <span class="keyword">super</span>.initState();</div><div class="line"></div><div class="line">        scrollController.addListener(_scrollListener);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@override</span></div><div class="line">    <span class="keyword">void</span> dispose() &#123;</div><div class="line">        scrollController.removeListener(_scrollListener);</div><div class="line"></div><div class="line">        scrollController.dispose();</div><div class="line">        <span class="keyword">super</span>.dispose();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">void</span> _scrollListener() &#123;</div><div class="line">        <span class="keyword">if</span> (scrollController.position.extentAfter &lt; <span class="number">64</span> * <span class="number">3</span>) &#123;</div><div class="line">            <span class="keyword">if</span>(widget.nextState == LoadingStatus.success &amp;&amp; widget.hasNext)&#123;</div><div class="line">                widget.fetchNextProjects(widget.currentPage + <span class="number">1</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@override</span></div><div class="line">    Widget build(BuildContext context) &#123;...&#125;</div><div class="line"></div><div class="line">    Widget _nextStateToText() &#123;</div><div class="line">        <span class="keyword">if</span>(!widget.hasNext) &#123;</div><div class="line">            <span class="keyword">return</span> Text(<span class="string">'加载成功，已无下一页'</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span>(widget.nextState == LoadingStatus.error)&#123;</div><div class="line">            <span class="keyword">return</span> Text(<span class="string">'加载失败，滑动重新加载'</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> Text(<span class="string">'加载中...'</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>Flutter是不同于ReactNative的跨端解决方案，是以一套代码实现高开发效率与高性能为目标，没有ReactNative的bridge，同时通过Dart解决javascript开发效率问题。</p>
<p>现在Flutter比较ReactNative的最大问题是：release下不支持”hot update”，官方的解释如下：</p>
<blockquote>
<p>Often people ask if Flutter supports “code push” or “hot update” or other similar names for pushing out-of-store updates to apps.</p>
<p>Currently we do not offer such a solution out of the box, but the primary blockers are not technological. Flutter supports just in time (JIT) or interpreter based execution on both Android and iOS devices. Currently we remove these libraries during –release builds, however we could easily include them.</p>
<p>The primary blockers to this feature resolve around current quirks of the iOS ecosystem which may require apps to use JavaScript for this kind of over-the-air-updates functionality. Thankfully Dart supports compiling to JavaScript and so one could imagine several ways in which one compile parts of ones application to JavaScript instead of Dart and thus allows replacement of or augmentation with those parts in deployed binaries.</p>
<p>This bug tracks adding some supported solution like this. I’ll dupe all the other reports here.</p>
<p>简单翻译：Flutter不支持release下的hot update，不是由于技术原因，而是iOS系统只支持javaScript实现无线更新功能，由于Dart可以转换为Javasript代码，所以有一种可能性：程序的一部分使用javascript，而不是dart，再通过动态下载这部分javascript代码，实现hot update。</p>
</blockquote>
<p>Flutter是否会成为主流的跨端解决方案，主要原因不在于其高的开发效率与高性能，主要是看Fushsia操作系统的覆盖程序，如果Fushsia能成为主流的物联网与Android设备的主流系统，Flutter才能真正成为主流。</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ol>
<li><a href="https://flutter.io/technical-overview/" target="_blank" rel="noopener">Technical Overview</a></li>
<li><a href="https://medium.com/@nhancv/why-i-move-to-flutter-34c4005b96ef" target="_blank" rel="noopener">Why I move to Flutter</a></li>
<li><a href="https://www.jianshu.com/p/7549b63a72d7" target="_blank" rel="noopener">Dart与消息循环机制[翻译]</a></li>
<li><a href="https://www.jianshu.com/p/9e6c470ea5bf" target="_blank" rel="noopener">Flutter快速上车之Widget</a></li>
<li><a href="https://medium.com/flutter-community/flutter-what-are-widgets-renderobjects-and-elements-630a57d05208" target="_blank" rel="noopener">Flutter, what are Widgets, RenderObjects and Elements?</a></li>
<li><a href="https://blog.novoda.com/introduction-to-redux-in-flutter/" target="_blank" rel="noopener">Introduction to Redux in Flutter</a></li>
<li><a href="https://flutterbyexample.com/user-feedback-toasts-snackbars/" target="_blank" rel="noopener">User Feedback: Toasts / Snackbars</a></li>
<li><a href="https://github.com/flutter/flutter/issues/14330" target="_blank" rel="noopener">Code Push / Hot Update / out of band updates</a></li>
</ol>

        </div>

        <blockquote class="post-copyright">
    
    <div class="content">
        
<span class="post-time">
    最后更新时间：<time datetime="2018-11-11T09:59:45.416Z" itemprop="dateUpdated">2018-11-11 17:59:45</time>
</span><br>


        
    </div>
    
    <footer>
        <a href="https://handsomeliuyang.github.io">
            <img src="/img/logo.png" alt="刘阳">
            刘阳
        </a>
    </footer>
</blockquote>

        


        <div class="post-footer">
            
	<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Flutter/">Flutter</a></li></ul>


            
<div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="二维码">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>



        </div>
    </div>

    
<nav class="post-nav flex-row flex-justify-between flex-row-reverse">
  

  
    <div class="waves-block waves-effect next">
      <a href="/2018/08/07/DiyReact学习之路/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">DiyReact学习之路</h4>
      </a>
    </div>
  
</nav>



    














</article>



</div>

        <footer class="footer">
    <div class="top">
        <!--
<p>
    <span id="busuanzi_container_site_uv" style='display:none'>
        站点总访客数：<span id="busuanzi_value_site_uv"></span>
    </span>
    <span id="busuanzi_container_site_pv" style='display:none'>
        站点总访问量：<span id="busuanzi_value_site_pv"></span>
    </span>
</p>

-->
        <p>
            <!--
            <span><a href="/atom.xml" target="_blank" class="rss" title="rss"><i class="icon icon-lg icon-rss"></i></a></span>
            -->
            <span>Hi, I'm LiuYang. For now I'm an Android Programmer in 58. This is my blog, believe it or not.</span>
        </p>
    </div>
    <div class="bottom">
        <p><span>刘阳 &copy; 2017 - 2018</span>
            <span>
                
                Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a>
            </span>
        </p>
    </div>
</footer>
    </main>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="二维码">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAPYAAAD2CAAAAADAeSUUAAADMElEQVR42u3aMXLDMAwEQP//00qbIpbvQDlj0csqk7ElLlNcAPDxiNfxa7Wf//2t43Sdf/f8CY93LGxsbOybsFe28mxbyWHlpGdvnB0rNjY29q7s823NMO1RnofWeRLlFmxsbGzs9jiu/UwSadjY2NjYyeOOYOVvSahJqwsbGxv7m9l5KyfZ1krTPy85/qmXho2Njf3x7Hwq+vk/v2W+jY2Njf3B7KNc7aig3WIbb8doYWNjY+/EzgMgb+u3qTFrb7VlBjY2Nvau7LZlv9L6mY0K2mONfoONjY29Efuqdn/ysrykacNy5Y+EjY2NfXd2zpt9ZuXaTV5y5CPkp7mNjY2NfXN2Hh758CDHtOPkvGk1HPRiY2Nj35D9jv/PrzqgFd7TZ2JjY2NvxF65XtPGUn58s7KkLWCwsbGx92C3W0kC4zx42iOe7erFk7GxsbE3Ys+uvJz/i9/GXju4zZ9QXNbBxsbG3oLdBsYs3tpLQrNorBc2Njb2bdmzAMh7VG2x0RYV7aj4xVQEGxsb+7bs2dWZdiQwax4ljaQ6RLGxsbE3Yl814l0fA88OfaUJhY2Njb0TO2m7zwYDK82g/Prm+beKOgkbGxv7hux2IHpVi382Kp4NfV/00rCxsbG3YCcxk29lFiptyXHBoBcbGxt7U/bs9bMioQ2t9VB8GmDY2NjYt2WvtJnaIUESjbOjTJ4ZhRw2Njb2zdltmM0GA7NyYhauRWhhY2Nj35Y9axXNyoaVaz3tkb04IGxsbOyvYbeXIPMnrAyV2wZTNN/GxsbGvi07YVwWG6MSJQ+5usjBxsbG3o5d9J9G35o9OQ+wtnDCxsbG3pV9Tlq/xJOE0Kz4SQ7ij1IEGxsbeyN2W0JcdflyVpY8gvWiBMLGxsbegn2UK2/Nr1/oaUOrHgxgY2Njb8HO1/pB5FGUv2Vl8IyNjY29E/uqFtJ6tNTD2jj2sLGxsb+B3V7laTfUHlBbGtVZjY2Njf3F7Dx4Zu3+9sn5bpcCDBsbG3sjdtudmg2AZwcxnG9jY2Njb8FOmkrthZuVEiIvaZKf//gNNjY29kbsfNDbBk/++byMWX8vNjY29kbsH1E5418UR2mgAAAAAElFTkSuQmCC" alt="微信分享二维码">
</div>




    <script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>
<script>
var BLOG = { ROOT: '/', SHARE: true, REWARD: false };


</script>

<script src="/js/main.min.js?v=1.7.2"></script>


<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<template id="search-tpl">
<li class="item">
    <a href="{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</template>

<script src="/js/search.min.js?v=1.7.2" async></script>






<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>



<script>
(function() {
    var OriginTitile = document.title, titleTime;
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            document.title = "LiuYang's Blog";
            clearTimeout(titleTime);
        } else {
            document.title = "LiuYang's Blog";
            titleTime = setTimeout(function() {
                document.title = OriginTitile;
            },2000);
        }
    });
})();
</script>



</body>
</html>
