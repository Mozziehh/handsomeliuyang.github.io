---
title: 58-Android的进程使用
date: 2016-03-22 11:08:08
categories: Android
tags: Android
---

# 进程介绍

在Android的系统里，进程的特点：

1. 进程是Linux系统占用资源的最小单位，如内存，CPU，IO资源等等
2. 进程之间的内存是完全独立的，在运行Android程序的进程里，每个进程都有一个Dalvik虚拟机
3. 在Android系统里，进程之间通信无法通过单例(static变量)来实现，只能通过下面几种方式：
    1. Activity
        1. 数据通过Intent传递
        2. 只能传递少量数据
        3. 只能单向，没有返回值
    2. Service
        1. 数据通过Intent传递
        2. 只能传递少量数据
        3. 单向，没有返回值
    3. Broadcast 
        1. 数据通过Intent传递
        2. 只能传递少量数据
        3. 只能单向，但可以广播，常用通知
    4. ContentProvider
        1. 数据通过ContentResolver传递
        2. 可以传比较多的数据
        3. 双向，使用较多
    5. AIDL
        1. Android的进程间通信，使用IBinder通信
        2. 最核心的通信方式，所有的通信在底层都使用IBinder方式
    6. Messenger
        1. 对AIDL的一种封装，对化暴率的API是Handler，简化进程间通信
        2. 单向，没有返回值

# Android的多进程

Android的四大组件：Activity, Service, Broadcast, ContentProvider都可以在通过属性android:process设置其所在的进程，在下面的一些场景，需要用到配置四大组件的进程属性：

1. 推送，存在于后台进程，即使主App进程被杀掉后，都希望在后存活，可以存在于后台进程
2. 插件，为了不让插件运行时，影响到主App的运行，这时最好的办法是让插件运行在独立的进程
3. 内存，当有内存消耗很大的组件，这时可以让其独立运行在一个进程
4. 退出程序时，主进程杀掉，想在后台做一些事情的话，可以把任务放在后台进程

多进程的影响：

1. 两个进程之间无法通过单例或对象来共享数据
2. 只能通过上面讲的通信方式来通信
3. 有很事情会执行两次，如定位，一些单例对象的实例，Application的初始化等等都会执行两次或多次，**而且很容易出现数据不一致的情况，尤其有共用Lib库的情况下**

# 58的进程分布

1. 主进程：com.wuba
    1. 基本上，90%以上的组件都在主进程
2. 子进程：":downloadapkservice"
    1. IM长连接Service
    2. IM的ContentProvider，用于操作IM的数据库
    3. 发送日志Service，用于发送统计日志
    4. 定时日志Service，用于定位启动统计日志
    5. 关键埋点发送日志Service，辅助修改用户问题
    6. InquiryDBUpdateInBgProvider，查询数据库的ContentProvider
    7. UserActionDBProvider，用户数据库的ContentProvider
    8. 小米相关
        1. NetworkStatusReceiver 小米
        2. PingReceiver 小米
        3. XMPushService 小米
        4. PushMessageHandler 小米
        5. MessageHandleService 小米
        6. **NotificationReceiver 58接收小米推送的广播接收者**
    9. CommonUpdateService，统一更新接口
    10. InstallFanqieService，安装番茄apk的Service
    11. TestOptionService，测试用的Service
    12. ResloveDataService，热修复的Patch下载Service
    13. JobPersonalCateService，全职招聘大类页数据更新Service
    14. DownLoadAPKService，下载新版本Apk的Service
    15. UpgradeApkService，更新下载Apk的Service
    16. com.baidu.location.f 百度定位Service
    17. OpenClientIntentService 发送开机启动Service
    18. PushService 暂时未知作用
3. 子进程："com.wuba.plugin.process"
    1. ActivityProxy，Proxy插件框架
    2. FragmentActivityProxy，Proxy插件框架
    3. PluginProcessService，Proxy插件框架
4. 子进程："com.wuba.plugin.dawn.process"
    1. PluginProcessService，DroidPlugin插件框架
    2. ActivityStub$XXX，DroidPlugin插件框架
    3. ServiceStub$XXX，DroidPlugin插件框架
    
# 子进程组件原则

由于子进程与主进程之间的通信问题，所以在做子进程的组件时，要注意一些事情：

1. 无法通过SharedPreference来进行数据通信，除非使用ContentProvider对SharedPreference进行包装
2. 使用的定位，单例服务和主进程的是不一样的
3. 通过共用文件来共享数据时，容易出现多进程并发问题
4. 在主进程里启动子进程里的组件时，时间会比较长，这个可以考虑子线程启动

# wuba子进程Service优化方案


    


